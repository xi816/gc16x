#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <stdbool.h>
#include <termios.h>

#include <sterm-control.h>

#define U0 void
#define U8 unsigned char
#define U16 unsigned short int
#define U32 unsigned int
#define U64 unsigned long long int

#define I8 char
#define I16 short int
#define I32 int
#define I64 long long int

#define MAXPAGES 256
#define PAGESIZE 256
#define LINESIZE 16

// Instructions (aligned to 5 bytes)
I8* GC_TABLE[][256] = {{
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "\033[94mPG0F \033[0m",
  "\033[94mPG10 \033[0m", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "RC   ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "RE   ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "RET  ", "STI  ", "...  ", "CLC  ", "...  ", "...  ", "...  ", "...  ", "RNE  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "HLT  ", "CLI  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "\033[94mPG66 \033[0m", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "DEXM ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "INXM ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "LOOP ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "CALL ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "COP  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "NOP  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  "},
  {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
  { // 0F
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "JME0 ", "JMNE0", "...  ", "...  ", "...  ", "...  ", "...  ",
  "JMP0 ", "JMP1 ", "JMP2 ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "POP1 ", "...  ", "...  ", "...  ", "PUSH0", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "PUSH1", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "INT0 ", "INT1 ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "CPUID", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  "},
  { // 10
  "ADD11", "SUB11", "MUL11", "DIV11", "...  ", "...  ", "...  ", "...  ", "ADDA0", "ADDB0", "ADDC0", "ADDD0", "ADDS0", "ADDG0", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "SUBA0", "SUBB0", "SUBC0", "SUBD0", "SUBS0", "SUBG0", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "MULA0", "MULB0", "MULC0", "MULD0", "MULS0", "MULG0", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "DIVA0", "DIVB0", "DIVC0", "DIVD0", "DIVS0", "DIVG0", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "STORB", "STGRB", "...  ", "...  ", "...  ", "...  ", "...  ", "LODSB", "STOSB", "LODGB", "STOGB", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "INXA ", "INXB ", "INXC ", "INXD ", "INXS ", "INXG ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "DECA ", "DECB ", "DECC ", "DECD ", "DECS ", "DECG ", "...  ", "...  ", "AND11", "OR11 ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "CMP10", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "CMP11", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  "},
  {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
  {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
  {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
  {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
  {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
  {}, {}, {}, {}, {}, {},
  { // 66
  "...  ", "...  ", "...  ", "...  ", "...  ", "LDA0 ", "LDB0 ", "LDC0 ", "LDD0 ", "LDS0 ", "LDG0 ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "LDAZ ", "LDBZ ", "LDCZ ", "LDDZ ", "LDSZ ", "LDGZ ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "LDAZS", "LDBZS", "LDCZS", "LDDZS", "LDSZS", "LDGZS", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "LDAZG", "LDBZG", "LDCZG", "LDDZG", "LDSZG", "LDGZG", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "LDAA ", "LDBA ", "LDCA ", "LDDA ", "LDSA ", "LDGA ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "LDAAS", "LDBAS", "LDCAS", "LDDAS", "LDSAS", "LDGAS", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "LDAAG", "LDBAG", "LDCAG", "LDDAG", "LDSAG", "LDGAG", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "LDA0S", "LDB0S", "LDC0S", "LDD0S", "LDS0S", "LDG0S", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "LDA0G", "LDB0G", "LDC0G", "LDD0G", "LDS0G", "LDG0G", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "LDA1 ", "LDB1 ", "LDC1 ", "LDD1 ", "LDS1 ", "LDG1 ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ",
  "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  ", "...  "}
};
U8 GC_LEGAL_PAGES[] = {
  0x0F, 0x10, 0x66
};

U0 render(U8 page, U8 ind) {
  printf("\033[H\033[K\033[1;37mGASMAN 1.2 | PAGE %02X (%d) | INDEX %02X (%03d) | REAL INDEX %04X (%05d)\033[0m\n", page, page, ind, ind, ((page*256)+ind), ((page*256)+ind));
  printf("     ");
  for (I16 i = 0; i < LINESIZE; i++) {
    printf("%02X    ", i);
  }
  for (I16 i = 0; i < PAGESIZE; i++) {
    if (i % LINESIZE == 0) {
      printf("\n%02X | ", i);
    }
    if (i == ind) {
      printf("\033[47m\033[30m%s\033[0m ", GC_TABLE[page][i]);
    }
    else {
      printf("%s ", GC_TABLE[page][i]);
    }
  }
}

U0 hexToDec() {
  U8 numbuf[19];
  for (I16 i = 0; i < 19; i++)
    numbuf[i] = 0;
  U8 numbufi = 0;
  U8 hk = 0;
  while (hk != 10) {
    printf("\033[20;25H |---------------------|");
    printf("\033[21;25H |ENTER VALUE          |");
    printf("\033[22;25H |: %s", numbuf);
    printf("\033[22;47H |");
    printf("\033[23;25H |ANSWER:              |");
    printf("\033[24;25H |---------------------|");
    hk = getchar();
    if ((hk >= 48) && (hk <= 57)) {
      numbuf[numbufi] = hk;
      numbufi++;
    }
  }
  I32 n = atoi(numbuf);
  printf("\033[20;25H |---------------------|");
  printf("\033[21;25H |ENTER VALUE          |");
  printf("\033[22;25H |: %s", numbuf);
  printf("\033[22;47H |");
  printf("\033[23;25H |ANSWER: %X", n);
  printf("\033[23;47H |");
  printf("\033[24;25H |---------------------|");
}

I32 main(I32 argc, I8** argv) {
  new_st;
  printf("\033[H\033[2J\033[?25l");
  U8 k = 32;
  U8 page = 0;
  U8 ind = 0;
  render(page, ind);
  while (true) {
    k = getchar();
    if (k == 'q') break;
    else if (k == '0') {
      page = 0;
      ind = 0;
    }
    else if (k == 'h') {
      hexToDec();
      getchar();
      printf("\033[H\033[2J");
    }
    else if (k == 10) {
      for (U8 i = 0; i < sizeof(GC_LEGAL_PAGES); i++) {
        if (ind == GC_LEGAL_PAGES[i]) {
          page = ind;
          ind = 0;
          break;
        }
      }
    }
    else if (k == 27) {
      getchar();
      switch (getchar()) {
        case 'A':
          ind -= 16;
          break;
        case 'B':
          ind += 16;
          break;
        case 'C':
          ind++;
          break;
        case 'D':
          ind--;
          break;
      }
    }
    render(page, ind);
  }
  old_st;
  puts("\033[?25h");
  return 0;
}

